{% extends "base.html" %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<div class="order-screen">
    <div class="header">
        <h1 class="header-title">FPV Shop</h1>
    </div>

    <div class="content">
        <h2 class="section-title">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è</h2>
        <div class="delivery-companies">
            <form id="deliveryForm">
                <label class="option-item" style="cursor:pointer;display:flex;align-items:center;gap:12px;">
                    <input type="radio" name="delivery" value="cdek" class="form-radio h-5 w-5 text-blue-600" checked>
                    <img src="https://papik.pro/grafic/uploads/posts/2023-04/thumbs/1681499998_papik-pro-p-logotip-sdek-vektor-26.jpg" alt="–°–î–≠–ö" class="delivery-icon">
                    <div class="option-text">–°–î–≠–ö</div>
                </label>
                <div class="spec-divider"></div>
                <label class="option-item" style="cursor:pointer;display:flex;align-items:center;gap:12px;">
                    <input type="radio" name="delivery" value="pochta" class="form-radio h-5 w-5 text-blue-600">
                    <img src="https://www.pochta.ru/assets/Emblema_Czvetnoj_na_svetlom_78f75308a1.jpg" alt="–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏" class="delivery-icon">
                    <div class="option-text">–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏</div>
                </label>
                <div class="spec-divider"></div>
                <label class="option-item" style="cursor:pointer;display:flex;align-items:center;gap:12px;">
                    <input type="radio" name="delivery" value="dpd" class="form-radio h-5 w-5 text-blue-600">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMHr-gzDhm4l_l-NfU9eODXC0QqYe6tWwGwg&s" alt="DPD" class="delivery-icon">
                    <div class="option-text">DPD</div>
                </label>
                <div class="spec-divider"></div>
                <label class="option-item" style="cursor:pointer;display:flex;align-items:center;gap:12px;">
                    <input type="radio" name="delivery" value="donetsk" class="form-radio h-5 w-5 text-blue-600">
                    <span class="option-emoji">üìç</span>
                    <div class="option-text">–ü–í–ó –î–æ–Ω–µ—Ü–∫</div>
                </label>
            </form>
        </div>
        
        <h2 class="section-title">–î–æ—Å—Ç–∞–≤–∫–∞</h2>
        
        <div class="address-card">
            <div class="address-info">
                <div class="address-input empty" contenteditable="true" data-placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—É–Ω–∫—Ç –ü–í–ó –∏–ª–∏ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"></div>
            </div>
        </div>

        <div class="delivery-option">
            <div class="option-item">
                <span class="option-emoji">üö™</span>
                <div class="option-text">–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–≤–µ—Ä–∏</div>
                <div class="toggle">
                    <div class="toggle-handle"></div>
                </div>
            </div>
        </div>
        
        <div class="spec-divider"></div>

        <h2 class="section-title">–°–ü–û–°–û–ë –û–ü–õ–ê–¢–´</h2>
        
        <div class="payment-options">
            <form id="paymentForm">
                <label class="option-item" style="cursor:pointer;display:flex;align-items:center;gap:12px;">
                    <input type="radio" name="payment_method" value="sbp" class="form-radio h-5 w-5 text-blue-600" checked>
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT3duc6q4jIb6WqObSkZL9f2IdBYKgjLBshoA&s" alt="–°–ë–ü" class="payment-icon">
                    <div class="option-text">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É ‚ÇΩ</div>
                </label>
                <div class="spec-divider"></div>
                <label class="option-item" style="cursor:pointer;display:flex;align-items:center;gap:12px;">
                    <input type="radio" name="payment_method" value="usdt" class="form-radio h-5 w-5 text-blue-600">
                    <img src="https://coinmetro.com/_next/static/media/USDT.e5b6b9e8.svg" alt="USDT" class="payment-icon">
                    <div class="option-text">USDT (TON)</div>
                </label>
            </form>
            <div class="spec-divider"></div>
            <div class="option-item">
                <svg class="payment-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21.41 11.58L12.41 2.58C12.05 2.22 11.55 2 11 2H4C2.9 2 2 2.9 2 4V11C2 11.55 2.22 12.05 2.59 12.42L11.59 21.42C11.95 21.78 12.45 22 13 22C13.55 22 14.05 21.78 14.41 21.41L21.41 14.41C21.78 14.05 22 13.55 22 13C22 12.45 21.77 11.94 21.41 11.58ZM5.5 7C4.67 7 4 6.33 4 5.5C4 4.67 4.67 4 5.5 4C6.33 4 7 4.67 7 5.5C7 6.33 6.33 7 5.5 7Z" fill="currentColor"/>
                </svg>
                <div class="option-text">–ü—Ä–æ–º–æ–∫–æ–¥</div>
                <button class="option-button" onclick="togglePromoInput(this)">–£–∫–∞–∑–∞—Ç—å</button>
                <div class="promo-input" style="display: none;">
                    <div class="input-field" contenteditable="true" data-placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥"></div>
                </div>
            </div>
            <div class="spec-divider"></div>

        </div>

        <!-- –£–¥–∞–ª—ë–Ω –±–ª–æ–∫ <div id="payment-method-content"></div> -->



        <div class="phone-section">
            <div class="option-item">
                <span class="option-emoji">üì±</span>
                <div class="option-text">–¢–µ–ª–µ—Ñ–æ–Ω</div>
            </div>
            <div class="phone-input" style="display: flex;">
                <div class="input-field" contenteditable="true" data-placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"></div>
            </div>
        </div>

        <h2 class="section-title">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è</h2>
        <div class="name-input">
            <div class="input-field" contenteditable="true" data-placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û"></div>
        </div>

        <div class="total-section">
            <div class="total-row">
                <span class="total-label">–ò—Ç–æ–≥–æ</span>
                <span class="total-amount">{{ total|int }} ‚ÇΩ</span>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="submit-button">
            –û–ø–ª–∞—Ç–∏—Ç—å
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.Telegram.WebApp.ready();

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞
    function initPlaceholder(element) {
        if (element.textContent.trim() === '') {
            element.classList.add('empty');
        } else {
            element.classList.remove('empty');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞
    function setupInput(input) {
        input.addEventListener('input', function() {
            initPlaceholder(this);
        });
        initPlaceholder(input);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    document.querySelectorAll('.input-field[contenteditable="true"]').forEach(setupInput);

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
    function selectDeliveryCompany(checkbox) {
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
        document.querySelectorAll('.delivery-companies .method-checkbox').forEach(cb => {
            cb.classList.remove('checked');
        });
        // –û—Ç–º–µ—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–µ–∫–±–æ–∫—Å
        checkbox.classList.add('checked');
    }
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.querySelectorAll('.delivery-companies .method-checkbox').forEach(cb => {
        cb.onclick = function() { selectDeliveryCompany(this); };
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    function togglePromoInput(button) {
        const parent = button.closest('.option-item');
        const input = parent.querySelector('.promo-input');
        if (input.style.display === 'none') {
            input.style.display = 'block';
            button.textContent = '–°–∫—Ä—ã—Ç—å';
            input.querySelector('.input-field').focus();
        } else {
            input.style.display = 'none';
            button.textContent = '–£–∫–∞–∑–∞—Ç—å';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—è –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function togglePhoneInput(button) {
        const phoneInput = document.querySelector('.phone-input');
        if (phoneInput.style.display === 'none') {
            phoneInput.style.display = 'flex';
            button.textContent = '–°–∫—Ä—ã—Ç—å';
            phoneInput.querySelector('.input-field').focus();
        } else {
            phoneInput.style.display = 'none';
            button.textContent = '–£–∫–∞–∑–∞—Ç—å';
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
    document.querySelectorAll('.toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
            toggle.classList.toggle('active');
        });
    });

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    function selectPaymentMethod(radio) {
        document.querySelectorAll('#paymentForm .option-item').forEach(item => {
            item.classList.remove('selected');
        });
        radio.closest('.option-item').classList.add('selected');
    }
    document.querySelectorAll('#paymentForm input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            selectPaymentMethod(this);
        });
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (radio.checked) selectPaymentMethod(radio);
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã –ø–æ —Å–ø–æ—Å–æ–±—É
    function loadPaymentMethodPage(method) {
        fetch(`/${method}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('payment-method-content').innerHTML = html;
            });
    }
    // –ü—Ä–∏ —Å–º–µ–Ω–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å –Ω—É–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.querySelectorAll('#paymentForm input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            loadPaymentMethodPage(this.value);
        });
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ä–∞–∑—É
        if (radio.checked) loadPaymentMethodPage(radio.value);
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Placeholder –¥–ª—è address-input
        var addressInput = document.querySelector('.address-input[data-placeholder]');
        if (addressInput) {
            addressInput.addEventListener('input', function() {
                if (this.textContent.trim() === '') {
                    this.classList.add('empty');
                } else {
                    this.classList.remove('empty');
                }
            });
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
            if (addressInput.textContent.trim() === '') {
                addressInput.classList.add('empty');
            } else {
                addressInput.classList.remove('empty');
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function copyPhoneNumber() {
        const phoneNumber = '+7 (992) 255-67-29';
        navigator.clipboard.writeText(phoneNumber).then(function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
            const button = event.target.closest('button');
            const originalIcon = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.innerHTML = originalIcon;
            }, 2000);
        }).catch(function(err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏: ', err);
        });
    }

    document.querySelector('.submit-button').addEventListener('click', function() {
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Ñ–æ—Ä–º—ã
        const address = document.querySelector('.address-input')?.textContent.trim() || '';
        const fio = document.querySelector('.name-input .input-field')?.textContent.trim() || '';
        const phone = document.querySelector('.phone-input .input-field')?.textContent.trim() || '';
        const payment_method = document.querySelector('input[name="payment_method"]:checked')?.value || '';
        // –î–æ—Å—Ç–∞–≤–∫–∞
        const delivery_radio = document.querySelector('input[name="delivery"]:checked');
        const delivery_method = delivery_radio ? delivery_radio.value : '';
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/create_order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                address,
                fio,
                phone,
                payment_method,
                delivery_method
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if (payment_method === 'sbp') {
                    window.location.href = `/spb?order_id=${data.order_id}`;
                } else if (payment_method === 'usdt') {
                    window.location.href = `/ton?order_id=${data.order_id}`;
                } else {
                    window.location.href = '/orders';
                }
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
            }
        });
    });
</script>
{% endblock %}

{% block head %}
{{ super() }}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %} 

{% block styles %}
<style>
    .hidden-radio {
        display: none;
    }
    .method-checkbox {
        width: 20px;
        height: 20px;
        border-radius: 6px;
        border: 2px solid #d1d5db;
        background: #fff;
        display: inline-block;
        transition: background 0.2s, border-color 0.2s;
        position: relative;
    }
    .hidden-radio:checked + .method-checkbox {
        background: #2563eb;
        border-color: #2563eb;
    }
    .hidden-radio:checked + .method-checkbox::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 2px;
        width: 6px;
        height: 12px;
        border: solid #fff;
        border-width: 0 2px 2px 0;
        border-radius: 1px;
        transform: rotate(45deg);
        pointer-events: none;
    }
    .form-radio {
        accent-color: #2563eb;
    }
    .address-input[data-placeholder]:empty:before {
        content: attr(data-placeholder);
        color: #a1a1aa;
        pointer-events: none;
        position: absolute;
    }
    .address-input {
        position: relative;
        min-height: 24px;
        outline: none;
    }
    .payment-options .option-item.selected {
        border: 2px solid #2563eb;
        background: #f0f6ff;
        border-radius: 12px;
    }
    .payment-options .option-item {
        transition: border 0.2s, background 0.2s;
        padding: 8px 4px;
    }
</style>
{% endblock %} 