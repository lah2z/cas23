{% extends "base.html" %}
{% block title %}Оплата через USDT TON{% endblock %}

{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата через USDT TON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body { 
            font-family: 'Roboto', sans-serif; 
            background: #181826; 
            min-height: 100vh; 
            color: #fff; 
        }
        .main-gradient-bg {
            background: linear-gradient(135deg, #0094ff 0%, #0077cc 100%);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 148, 255, 0.3);
        }
        .card-input { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); 
            transition: all 0.3s; 
        }
        .card-input:focus { 
            background: rgba(255,255,255,0.15); 
            border-color: #0094ff; 
            box-shadow: 0 0 0 2px rgba(0, 148, 255, 0.3); 
        }
        .glow-effect { 
            box-shadow: 0 0 15px rgba(0, 148, 255, 0.5); 
        }
        .ton-card {
            background: rgb(19, 34, 53);
            border-radius: 12px;
            transform-style: preserve-3d;
            perspective: 1000px;
            position: relative;
            overflow: hidden;
        }
        .ton-logo {
            background: linear-gradient(135deg, #0094ff 0%, #0077cc 100%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .input-group { position: relative; }
        .input-group i { 
            position: absolute; 
            left: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: rgba(255,255,255,0.7); 
        }
        .input-group input { padding-left: 40px; }
        .animate-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 
            0% { opacity: 0.8; } 
            50% { opacity: 1; } 
            100% { opacity: 0.8; } 
        }
        .btn-pay {
            background: linear-gradient(135deg, #0094ff 0%, #0077cc 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 148, 255, 0.3);
        }
        .btn-pay i {
            color: #4ade80;
        }
        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .btn-cancel i {
            color: #f87171;
        }
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            width: 100%;
        }
        .address-box {
            background: rgba(0, 148, 255, 0.1);
            border: 1px dashed rgba(0, 148, 255, 0.5);
            border-radius: 8px;
            padding: 12px;
            word-break: break-all;
            text-align: center;
            font-family: monospace;
            position: relative;
        }
        .qrcode-container {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin: 0 auto;
            width: fit-content;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
{% endblock %}

{% block content %}
<div class="w-full max-w-md mx-auto p-4">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-blue-400 mb-2">Заказ #<span id="order-number">{{ order.order_number if order else order_id }}</span></h1>
        <p class="text-gray-300">Оплата через USDT TON</p>
    </div>
    <div class="main-gradient-bg p-6 shadow-xl border border-gray-700 mb-6 glow-effect">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-bold text-blue-300">Перевод в сети TON</h2>
                <p class="text-gray-400 text-sm">Криптовалютный платеж</p>
            </div>
            <div class="text-blue-400 text-2xl">
                <i class="fas fa-coins"></i>
            </div>
        </div>
        <div class="ton-card p-4 mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-16 h-16 bg-white bg-opacity-20 rounded-full -mr-4 -mt-4"></div>
            <div class="absolute bottom-0 right-0 w-16 h-16 bg-white bg-opacity-10 rounded-full -mr-4 -mb-4"></div>
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center gap-2">
                    <div class="ton-logo">
                        <img src="https://coinmetro.com/_next/static/media/USDT.e5b6b9e8.svg" alt="USDT" class="h-6">
                    </div>
                    <span class="text-white font-medium">USDT (TON Network)</span>
                </div>
            </div>
            <div class="mb-4">
                <div class="text-white text-opacity-70 text-xs mb-1">Адрес кошелька получателя</div>
                <div class="flex items-center">
                    <div class="text-white text-sm font-mono tracking-wider" id="ton-address">UQChUdBcl5DzNZasY-7uZ0dL2MgK3pZ-Mvjz-Qev9x3y4nCM</div>
                    <button onclick="copyTonAddress()" class="ml-2 text-blue-300 hover:text-white transition-colors duration-200">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="qrcode-container mb-6">
            <canvas id="ton-qrcode" width="200" height="200" style="display: block; margin: 0 auto;"></canvas>
        </div>
        <form>
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-medium mb-2">
                    Сумма к оплате <span class="text-red-400">*</span>
                </label>
                <div class="text-white text-2xl font-bold">
                    <span id="usdt-amount">...</span> USDT
                </div>
                <div class="text-gray-400 text-sm mt-1">≈ <span id="rub-amount">{{ '%.2f' % total if total is not none else '0.00' }}</span> ₽</div>
            </div>
            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-medium mb-2" for="email">
                    Email для уведомления
                </label>
                <div class="input-group">
                    <i class="far fa-envelope"></i>
                    <input id="email" type="email" class="w-full card-input rounded-lg py-3 px-4 text-gray-800 placeholder-gray-500 focus:outline-none" placeholder="Ваш email">
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn-pay">
                    <i class="fas fa-check-circle"></i> Оплатил
                </button>
                <button type="button" class="btn-cancel">
                    <i class="fas fa-times-circle"></i> Отменить
                </button>
            </div>
        </form>
    </div>
    <div class="text-center text-gray-400 text-xs">
        <p class="mb-1">Платежи защищены блокчейном TON</p>
    </div>
</div>

<!-- Модальные окна -->
<div id="paymentConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <i class="fas fa-check text-green-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Подтверждение оплаты</h3>
            <p class="text-sm text-gray-500 mb-6">Вы действительно оплатили перевод на сумму <span id="modal-usdt-amount">...</span> USDT?</p>
            <div class="flex space-x-3">
                <button id="confirmPaymentBtn" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                    Да, оплатил
                </button>
                <button id="cancelPaymentBtn" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                    Нет
                </button>
            </div>
        </div>
    </div>
</div>
<div id="cancelConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-times text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Подтверждение отмены</h3>
            <p class="text-sm text-gray-500 mb-6">Вы действительно хотите отменить перевод?</p>
            <div class="flex space-x-3">
                <button id="confirmCancelBtn" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                    Да, отменить
                </button>
                <button id="cancelCancelBtn" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                    Нет
                </button>
            </div>
        </div>
    </div>
</div>
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <i class="fas fa-check-circle text-green-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Платеж в обработке!</h3>
            <p class="text-sm text-gray-500 mb-6">После зачисления средств мы начнем сборку заказа.</p>
            <button id="closeSuccessBtn" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                ОК
            </button>
        </div>
    </div>
</div>
<div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Ошибка</h3>
            <p id="errorMessage" class="text-sm text-gray-500 mb-6">Произошла ошибка при обработке запроса.</p>
            <button id="closeErrorBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                ОК
            </button>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
    // Генерация QR-кода
    const tonAddress = "UQChUdBcl5DzNZasY-7uZ0dL2MgK3pZ-Mvjz-Qev9x3y4nCM";
    QRCode.toCanvas(document.getElementById('ton-qrcode'), tonAddress, {
        width: 200,
        margin: 0,
        color: { dark: '#000000', light: '#ffffff' }
    }, function(error) { if (error) console.error(error); });

    // Получение курса USDT/RUB и расчет суммы
    const rubAmount = Number("{{ '%.2f' % total if total is not none else '0.00' }}");
    let usdtAmount = 0;
    function formatAmount(val) {
        return Number(val).toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function updateAmounts() {
        document.getElementById('rub-amount').textContent = formatAmount(rubAmount);
        document.getElementById('usdt-amount').textContent = formatAmount(usdtAmount);
        document.getElementById('modal-usdt-amount').textContent = formatAmount(usdtAmount);
    }
    fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTRUB')
        .then(r => r.json())
        .then(data => {
            const rate = parseFloat(data.price);
            usdtAmount = rubAmount / rate;
            updateAmounts();
        })
        .catch(() => {
            usdtAmount = rubAmount / 90; // fallback
            updateAmounts();
        });

    // Модальные окна и обработчики
    function showModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
    function hideModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
    function showError(message) { document.getElementById('errorMessage').textContent = message; showModal('errorModal'); }
    function updateOrderStatus(status) {
        const orderId = '{{ order_id }}';
        if (orderId === 'None' || !orderId) { showError('Ошибка: не найден ID заказа'); return; }
        const orderData = { order_id: parseInt(orderId), status: status };
        fetch('/update_order_status', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (status === 'paid') { showModal('successModal'); } else { window.location.href = '/orders'; }
            } else { showError('Ошибка при обновлении статуса заказа: ' + (data.error || 'Неизвестная ошибка')); }
        })
        .catch(error => { console.error('Error:', error); showError('Ошибка при обновлении статуса заказа'); });
    }
    document.querySelector('.btn-pay').addEventListener('click', function() { showModal('paymentConfirmModal'); });
    document.querySelector('.btn-cancel').addEventListener('click', function() { showModal('cancelConfirmModal'); });
    document.getElementById('confirmPaymentBtn').addEventListener('click', function() { hideModal('paymentConfirmModal'); updateOrderStatus('paid'); });
    document.getElementById('cancelPaymentBtn').addEventListener('click', function() { hideModal('paymentConfirmModal'); });
    document.getElementById('confirmCancelBtn').addEventListener('click', function() { hideModal('cancelConfirmModal'); updateOrderStatus('cancelled'); });
    document.getElementById('cancelCancelBtn').addEventListener('click', function() { hideModal('cancelConfirmModal'); });
    document.getElementById('closeSuccessBtn').addEventListener('click', function() { hideModal('successModal'); window.location.href = '/orders'; });
    document.getElementById('closeErrorBtn').addEventListener('click', function() { hideModal('errorModal'); });
    document.querySelectorAll('[id$="Modal"]').forEach(modal => {
        modal.addEventListener('click', function(e) { if (e.target === this) { hideModal(this.id); } });
    });
    function copyTonAddress() {
        const copyBtn = document.querySelector('#ton-address + button .fa-copy');
        navigator.clipboard.writeText(tonAddress)
            .then(() => {
                copyBtn.classList.remove('fa-copy');
                copyBtn.classList.add('fa-check', 'text-green-400');
                setTimeout(() => {
                    copyBtn.classList.remove('fa-check', 'text-green-400');
                    copyBtn.classList.add('fa-copy');
                }, 2000);
            })
            .catch(err => {
                console.error('Ошибка копирования: ', err);
                copyBtn.classList.remove('fa-check', 'text-green-400');
                copyBtn.classList.add('fa-copy');
            });
    }
</script>
{% endblock %}