{% extends "base.html" %}

{% block title %}FPV Shop{% endblock %}

{% block content %}
<div class="main-screen">
    <div class="header">
        <button class="menu-button" onclick="window.location.href='/profile'">‚ò∞</button>
        <h1 class="header-title">FPV Shop</h1>
    </div>

    <div class="categories">
        <a href="#" class="category active" data-category="0">–í—Å–µ</a>
        {% for category in categories %}
        <a href="#" class="category" data-category="{{ category.id }}">
            {{ category.name }}
        </a>
        {% endfor %}
    </div>

    <div class="products-grid" id="productsGrid">
        {% for product in products %}
        <a href="/product/{{ product.id }}" class="product-card">
            {% if product.image %}
            <img src="{{ url_for('static', filename='images/products/' + product.image) }}" alt="{{ product.title }}" class="product-image">
            {% else %}
            <div class="product-image no-image">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            {% endif %}
            <div class="product-info">
                <h3 class="product-title">{{ product.title }}</h3>
                <p class="product-description">{{ product.description }}</p>
                <div class="product-price">{{ "{:,.0f}".format(product.price).replace(",", " ") }} ‚ÇΩ</div>
                <div class="product-actions">
                    <button class="btn-add-to-cart" data-product-id="{{ product.id }}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>

    <div class="bottom-bar">
        <button class="cart-button" onclick="openCart()">
            <span class="cart-icon">üõí</span>
            –ö–æ—Ä–∑–∏–Ω–∞ ‚Ä¢ <span id="cartCount">{{ cart_count }}</span> —Ç–æ–≤–∞—Ä–æ–≤ ‚Ä¢ <span id="cartTotal">{{ cart_total }}</span> ‚ÇΩ
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.Telegram.WebApp.ready();
    document.addEventListener('DOMContentLoaded', function() {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ session, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
        var userId = "{{ session['user']['id'] if session.get('user') else '' }}";
        if (
            window.Telegram && window.Telegram.WebApp &&
            window.Telegram.WebApp.initDataUnsafe &&
            window.Telegram.WebApp.initDataUnsafe.user &&
            !userId
        ) {
            const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
            fetch('/api/telegram_user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: tgUser.id,
                    first_name: tgUser.first_name,
                    last_name: tgUser.last_name,
                    username: tgUser.username,
                    photo_url: tgUser.photo_url
                })
            }).then(() => location.reload());
        }
    });

    function openCart() {
        window.location.href = '/cart';
    }

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'add-to-cart-success';
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í –∫–æ—Ä–∑–∏–Ω—É"
    document.getElementById('productsGrid').addEventListener('click', async function(e) {
        if (e.target.classList.contains('btn-add-to-cart')) {
            e.preventDefault();
            e.stopPropagation();
            const productId = e.target.dataset.productId;
            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ product_id: productId })
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('cartCount').textContent = data.cart_count;
                    document.getElementById('cartTotal').textContent = data.cart_total.toLocaleString();
                    e.target.classList.add('added');
                    setTimeout(() => {
                        e.target.classList.remove('added');
                    }, 500);
                    showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É');
            }
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const categories = Array.from(document.querySelectorAll('.category'));
    let currentCategory = categories[0];

    categories.forEach(category => {
        category.addEventListener('click', function(e) {
            e.preventDefault();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
            const currentRect = currentCategory.getBoundingClientRect();
            const newRect = this.getBoundingClientRect();
            const direction = newRect.left > currentRect.left ? 'right' : 'left';
            currentCategory = this;
            
            // –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            categories.forEach(c => c.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            this.classList.add('active');
            
            const categoryId = this.dataset.category;
            const productsGrid = document.getElementById('productsGrid');
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            const newContent = document.createElement('div');
            newContent.className = 'new-content';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã
            fetch(`/category/${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    newContent.innerHTML = data.products.map(product => `
                        <a href="/product/${product.id}" class="product-card">
                            ${product.image ? 
                                `<img src="/static/images/products/${product.image}" alt="${product.title}" class="product-image">` :
                                '<div class="product-image no-image">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>'
                            }
                            <div class="product-info">
                                <h3 class="product-title">${product.title}</h3>
                                <p class="product-description">${product.description}</p>
                                <div class="product-price">${product.price.toLocaleString()} ‚ÇΩ</div>
                                <div class="product-actions">
                                    <button class="btn-add-to-cart" data-product-id="${product.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                                </div>
                            </div>
                        </a>
                    `).join('');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ —Å–µ—Ç–∫—É
                    productsGrid.appendChild(newContent);
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
                    productsGrid.classList.add(`slide-out-${direction}`);
                    newContent.classList.add(`slide-in-${direction}`);
                    
                    // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                    setTimeout(() => {
                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
                        const oldContent = productsGrid.querySelector('.product-card');
                        if (oldContent) {
                            oldContent.remove();
                        }
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–∏
                        productsGrid.classList.remove(`slide-out-${direction}`);
                        newContent.classList.remove(`slide-in-${direction}`);
                        
                        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ
                        productsGrid.innerHTML = newContent.innerHTML;
                    }, 300);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–æ–≤');
                });
        });
    });
</script>
{% endblock %} 